<!DOCTYPE html>

<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ - HOTEL 725</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Sylfaen', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        h2 { color: #2c3e50; margin-bottom: 20px; }
        h3 { color: #34495e; margin: 25px 0 15px; border-bottom: 2px solid #eee; padding-bottom: 8px; }


    .cards { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
    .card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); flex: 1; min-width: 280px; }
    .card-header { font-size: 16px; font-weight: 700; color: #1a5490; margin-bottom: 15px; }

    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: #1a5490; color: white; }
    .btn-primary:hover { background: #0d3b6e; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .stat-row { display: flex; justify-content: space-between; padding: 8px 12px; background: #f8f9fa; border-radius: 5px; }
    .stat-row .label { color: #666; font-size: 13px; }
    .stat-row .value { font-weight: 700; color: #2c3e50; }

    .log-box { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; font-family: 'Consolas', 'Courier New', monospace; font-size: 12px; line-height: 1.6; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
    .log-box .log-error { color: #f44336; }
    .log-box .log-info { color: #4caf50; }
    .log-box .log-warn { color: #ff9800; }

    .toolbar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
    .info-text { font-size: 12px; color: #999; margin-top: 8px; }
</style>


</head>
<body>
    <h2>âš™ï¸ áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ</h2>


<!-- Backup Section -->
<div class="cards">
    <div class="card">
        <div class="card-header">ğŸ’¾ áƒ‘áƒáƒ–áƒ˜áƒ¡ Backup</div>
        <p style="color:#666; font-size:13px; margin-bottom:15px;">áƒ§áƒ•áƒ”áƒšáƒ áƒªáƒ®áƒ áƒ˜áƒšáƒ˜áƒ¡ SQL áƒ”áƒ¥áƒ¡áƒáƒáƒ áƒ¢áƒ˜ â€” phpMyAdmin-áƒ¨áƒ˜ áƒ¨áƒ”áƒ›áƒáƒ¢áƒáƒœáƒ (import) áƒ¨áƒ”áƒ¡áƒáƒ«áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ</p>
        <button class="btn btn-primary" onclick="downloadBackup()" id="backupBtn">ğŸ“¥ SQL Backup áƒ’áƒáƒ“áƒ›áƒáƒ¬áƒ”áƒ áƒ</button>
        <p class="info-text">áƒ‘áƒáƒšáƒ backup: <span id="lastBackupTime">â€”</span></p>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“Š áƒ‘áƒáƒ–áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ</div>
        <div id="dbStats">
            <p style="color:#999;">áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</p>
        </div>
    </div>
</div>

<!-- Error Logs Section -->
<h3>ğŸ“‹ áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ˜áƒ¡ áƒšáƒáƒ’áƒ”áƒ‘áƒ˜</h3>
<div class="toolbar">
    <button class="btn btn-primary" onclick="loadLogs()">ğŸ”„ áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ</button>
    <button class="btn btn-danger" onclick="clearLogs()">ğŸ—‘ï¸ áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</button>
    <span style="margin-left:auto; font-size:12px; color:#999;" id="logInfo"></span>
</div>
<div class="log-box" id="logBox">áƒšáƒáƒ’áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ...</div>

<script>
    const BACKUP_API = 'backup_api.php';

    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadLogs();
    });

    // === Backup ===
    function downloadBackup() {
        const btn = document.getElementById('backupBtn');
        btn.disabled = true;
        btn.textContent = 'â³ áƒ›áƒ–áƒáƒ“áƒ“áƒ”áƒ‘áƒ...';

        // áƒáƒ˜áƒ áƒ“áƒáƒáƒ˜áƒ áƒ˜ áƒ’áƒáƒ“áƒ›áƒáƒ¬áƒ”áƒ áƒ
        const link = document.createElement('a');
        link.href = BACKUP_API + '?action=export';
        link.download = 'hotel725_backup.sql';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = 'ğŸ“¥ SQL Backup áƒ’áƒáƒ“áƒ›áƒáƒ¬áƒ”áƒ áƒ';
            document.getElementById('lastBackupTime').textContent = new Date().toLocaleString('ka-GE');
        }, 2000);
    }

    // === áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ ===
    async function loadStats() {
        try {
            const res = await fetch(BACKUP_API + '?action=stats', { credentials: 'include' });
            const json = await res.json();

            if (json.success) {
                let html = '<div class="stat-grid">';
                const tableNames = {
                    'rooms': 'ğŸšª áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜',
                    'realizations': 'ğŸ“‹ áƒ áƒ”áƒáƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ”áƒ‘áƒ˜',
                    'realization_guests': 'ğŸ‘¤ áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ”áƒ‘áƒ˜',
                    'realization_rooms': 'ğŸ›ï¸ áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒœáƒáƒ¬áƒ”áƒ áƒ”áƒ‘áƒ˜',
                    'bookings': 'ğŸ“… áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜',
                    'blocked_rooms': 'ğŸ”’ áƒ‘áƒšáƒáƒ™áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜'
                };

                for (const [table, info] of Object.entries(json.tables)) {
                    const name = tableNames[table] || table;
                    const color = info.exists ? (info.count > 0 ? '#28a745' : '#999') : '#e74c3c';
                    html += `<div class="stat-row">
                        <span class="label">${name}</span>
                        <span class="value" style="color:${color};">${info.exists ? info.count + ' áƒ©áƒáƒœáƒáƒ¬áƒ”áƒ áƒ˜' : 'âŒ áƒáƒ  áƒáƒ áƒ¡áƒ”áƒ‘áƒáƒ‘áƒ¡'}</span>
                    </div>`;
                }

                html += `<div class="stat-row">
                    <span class="label">ğŸ“ áƒšáƒáƒ’áƒ˜áƒ¡ áƒ–áƒáƒ›áƒ</span>
                    <span class="value">${json.logSizeHuman}</span>
                </div>`;
                html += `<div class="stat-row">
                    <span class="label">ğŸ• áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ˜áƒ¡ áƒ“áƒ áƒ</span>
                    <span class="value">${json.serverTime}</span>
                </div>`;
                html += '</div>';

                document.getElementById('dbStats').innerHTML = html;
            }
        } catch(e) {
            document.getElementById('dbStats').innerHTML = '<p style="color:#e74c3c;">âŒ áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ</p>';
        }
    }

    // === áƒšáƒáƒ’áƒ”áƒ‘áƒ˜ ===
    async function loadLogs() {
        try {
            const res = await fetch(BACKUP_API + '?action=logs&lines=200', { credentials: 'include' });
            const json = await res.json();

            if (json.success) {
                const box = document.getElementById('logBox');
                if (!json.logs || json.logs.trim() === '') {
                    box.textContent = 'âœ… áƒšáƒáƒ’áƒ˜ áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ â€” áƒ§áƒ•áƒ”áƒšáƒáƒ¤áƒ”áƒ áƒ˜ áƒ™áƒáƒ áƒ’áƒáƒ“áƒáƒ';
                } else {
                    box.innerHTML = formatLogs(json.logs);
                }
                document.getElementById('logInfo').textContent = 
                    'áƒ¡áƒ£áƒš: ' + (json.totalLines || 0) + ' áƒ®áƒáƒ–áƒ˜';
            }
        } catch(e) {
            document.getElementById('logBox').textContent = 'âŒ áƒšáƒáƒ’áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ';
        }
    }

    function formatLogs(text) {
        return text.split('\n').map(line => {
            if (line.includes('error') || line.includes('Error') || line.includes('failed')) {
                return '<span class="log-error">' + esc(line) + '</span>';
            } else if (line.includes('success') || line.includes('created') || line.includes('Login success')) {
                return '<span class="log-info">' + esc(line) + '</span>';
            } else if (line.includes('deleted') || line.includes('cleared')) {
                return '<span class="log-warn">' + esc(line) + '</span>';
            }
            return esc(line);
        }).join('\n');
    }

    async function clearLogs() {
        if (!confirm('áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ¡áƒ£áƒ áƒ— áƒšáƒáƒ’áƒ˜áƒ¡ áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ?')) return;
        try {
            const res = await fetch(BACKUP_API + '?action=clear_logs', {
                method: 'POST',
                credentials: 'include'
            });
            const json = await res.json();
            if (json.success) {
                loadLogs();
                loadStats();
            }
        } catch(e) {
            alert('âŒ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ');
        }
    }

    function esc(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }
</script>


</body>
</html>