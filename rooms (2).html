<!DOCTYPE html>

<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ - HOTEL 725</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Sylfaen', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        h2 { color: #2c3e50; margin-bottom: 20px; }


    .toolbar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 13px; font-weight: 600; }
    .btn-primary { background: #1a5490; color: white; }
    .btn-primary:hover { background: #0d3b6e; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #1e7e34; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn-sm { padding: 5px 12px; font-size: 12px; }

    .stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { background: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; min-width: 120px; }
    .stat-card .num { font-size: 28px; font-weight: 700; color: #1a5490; }
    .stat-card .label { font-size: 12px; color: #666; margin-top: 4px; }

    .floor-section { margin-bottom: 25px; }
    .floor-header { background: #1a5490; color: white; padding: 10px 20px; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
    .floor-header .count { font-size: 12px; opacity: 0.8; font-weight: 400; }

    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    th { background: #ecf0f1; padding: 10px 15px; text-align: left; font-size: 13px; color: #2c3e50; border: 1px solid #ddd; }
    td { padding: 10px 15px; border: 1px solid #eee; font-size: 13px; }
    tr:hover { background: #f8f9fa; }

    .type-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .type-Single { background: #e8f5e9; color: #2e7d32; }
    .type-Double { background: #e3f2fd; color: #1565c0; }
    .type-Twin { background: #f3e5f5; color: #7b1fa2; }
    .type-Triple { background: #fff3e0; color: #e65100; }
    .type-LUX { background: #fce4ec; color: #c62828; }

    .status-active { color: #28a745; font-weight: 600; }
    .status-inactive { color: #e74c3c; font-weight: 600; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; border-radius: 12px; padding: 30px; width: 450px; max-width: 95vw; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .modal h3 { margin-bottom: 20px; color: #2c3e50; }
    .form-row { margin-bottom: 15px; }
    .form-row label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #555; }
    .form-row input, .form-row select { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; }
    .form-row input:focus, .form-row select:focus { border-color: #1a5490; outline: none; }
    .form-row-inline { display: flex; gap: 15px; }
    .form-row-inline .form-row { flex: 1; }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

    .empty-msg { text-align: center; padding: 40px; color: #999; }
    .filter-select { padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit; font-size: 13px; }
</style>


</head>
<body>
    <h2>ğŸšª áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ</h2>


<div class="toolbar">
    <button class="btn btn-primary" onclick="openAddModal()">â• áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
    <select class="filter-select" id="filterFloor" onchange="renderRooms()">
        <option value="">áƒ§áƒ•áƒ”áƒšáƒ áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜</option>
    </select>
    <select class="filter-select" id="filterType" onchange="renderRooms()">
        <option value="">áƒ§áƒ•áƒ”áƒšáƒ áƒ¢áƒ˜áƒáƒ˜</option>
        <option value="Single">Single</option>
        <option value="Double">Double</option>
        <option value="Twin">Twin</option>
        <option value="Triple">Triple</option>
        <option value="LUX">LUX</option>
    </select>
    <select class="filter-select" id="filterStatus" onchange="renderRooms()">
        <option value="">áƒ§áƒ•áƒ”áƒšáƒ</option>
        <option value="1">áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜</option>
        <option value="0">áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜</option>
    </select>
    <span id="statusMsg" style="margin-left:auto; font-size:12px; color:#666;"></span>
</div>

<div class="stats" id="statsBar"></div>
<div id="roomsContainer"></div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="roomModal">
    <div class="modal">
        <h3 id="modalTitle">áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</h3>
        <input type="hidden" id="editId">

        <div class="form-row-inline">
            <div class="form-row">
                <label>áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ˜ *</label>
                <input type="text" id="mRoomNumber" placeholder="áƒ›áƒáƒ’: 701" maxlength="10">
            </div>
            <div class="form-row">
                <label>áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜ *</label>
                <input type="number" id="mFloor" placeholder="1-10" min="1" max="20">
            </div>
        </div>

        <div class="form-row-inline">
            <div class="form-row">
                <label>áƒ¢áƒ˜áƒáƒ˜ *</label>
                <select id="mRoomType">
                    <option value="Single">Single</option>
                    <option value="Double">Double</option>
                    <option value="Twin">Twin</option>
                    <option value="Triple">Triple</option>
                    <option value="LUX">LUX</option>
                </select>
            </div>
            <div class="form-row">
                <label>áƒ¤áƒáƒ¡áƒ˜ (áƒš/áƒ¦áƒáƒ›áƒ”)</label>
                <input type="number" id="mPrice" placeholder="0" min="0" step="5">
            </div>
        </div>

        <div class="form-row" id="statusRow" style="display:none;">
            <label>áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</label>
            <select id="mActive">
                <option value="1">áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜</option>
                <option value="0">áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜</option>
            </select>
        </div>

        <div class="modal-actions">
            <button class="btn" style="background:#eee;" onclick="closeModal()">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
            <button class="btn btn-success" id="saveBtn" onclick="saveRoom()">ğŸ’¾ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        </div>
    </div>
</div>

<script>
    const API = 'get_realizations.php';
    let rooms = [];

    document.addEventListener('DOMContentLoaded', () => loadRooms());

    async function loadRooms() {
        document.getElementById('statusMsg').textContent = 'â³ áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...';
        try {
            const res = await fetch(API + '?action=rooms', { credentials: 'include' });

            if (res.status === 401) {
                document.getElementById('roomsContainer').innerHTML = '<div class="empty-msg">âŒ áƒ¡áƒ”áƒ¡áƒ˜áƒ áƒáƒ›áƒáƒ˜áƒ¬áƒ£áƒ áƒ. áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ®áƒ”áƒšáƒáƒ®áƒšáƒ áƒ¨áƒ”áƒ“áƒ˜áƒ—.</div>';
                return;
            }

            const json = await res.json();
            if (json.success) {
                rooms = json.data;
                populateFloorFilter();
                renderRooms();
                renderStats();
                document.getElementById('statusMsg').textContent = 'âœ… ' + rooms.length + ' áƒáƒ—áƒáƒ®áƒ˜';
            } else {
                document.getElementById('statusMsg').textContent = 'âŒ ' + (json.error || '');
            }
        } catch(e) {
            document.getElementById('statusMsg').textContent = 'âŒ áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ';
            console.error(e);
        }
    }

    function populateFloorFilter() {
        const floors = [...new Set(rooms.map(r => r.floor))].sort((a,b) => a-b);
        const sel = document.getElementById('filterFloor');
        sel.innerHTML = '<option value="">áƒ§áƒ•áƒ”áƒšáƒ áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜</option>' +
            floors.map(f => `<option value="${f}">áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜ ${f}</option>`).join('');
    }

    function getFilteredRooms() {
        const fFloor = document.getElementById('filterFloor').value;
        const fType = document.getElementById('filterType').value;
        const fStatus = document.getElementById('filterStatus').value;

        return rooms.filter(r => {
            if (fFloor && String(r.floor) !== fFloor) return false;
            if (fType && r.room_type !== fType) return false;
            if (fStatus !== '' && String(r.is_active) !== fStatus) return false;
            return true;
        });
    }

    function renderStats() {
        const active = rooms.filter(r => r.is_active == 1).length;
        const inactive = rooms.filter(r => r.is_active == 0).length;
        const floors = new Set(rooms.map(r => r.floor)).size;
        const types = {};
        rooms.filter(r => r.is_active == 1).forEach(r => { types[r.room_type] = (types[r.room_type]||0) + 1; });

        let html = `
            <div class="stat-card"><div class="num">${rooms.length}</div><div class="label">áƒ¡áƒ£áƒš áƒáƒ—áƒáƒ®áƒ˜</div></div>
            <div class="stat-card"><div class="num" style="color:#28a745;">${active}</div><div class="label">áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜</div></div>
            ${inactive > 0 ? `<div class="stat-card"><div class="num" style="color:#e74c3c;">${inactive}</div><div class="label">áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜</div></div>` : ''}
            <div class="stat-card"><div class="num">${floors}</div><div class="label">áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜</div></div>
        `;
        Object.entries(types).forEach(([t,c]) => {
            html += `<div class="stat-card"><div class="num">${c}</div><div class="label">${t}</div></div>`;
        });
        document.getElementById('statsBar').innerHTML = html;
    }

    function renderRooms() {
        const filtered = getFilteredRooms();
        const container = document.getElementById('roomsContainer');

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-msg">áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜ áƒáƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ</div>';
            return;
        }

        // áƒ¯áƒ’áƒ£áƒ¤áƒáƒ“ áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ—
        const byFloor = {};
        filtered.forEach(r => {
            const f = r.floor;
            if (!byFloor[f]) byFloor[f] = [];
            byFloor[f].push(r);
        });

        let html = '';
        Object.keys(byFloor).sort((a,b) => a-b).forEach(floor => {
            const floorRooms = byFloor[floor];
            html += `
            <div class="floor-section">
                <div class="floor-header">
                    <span>ğŸ¢ áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜ ${floor}</span>
                    <span class="count">${floorRooms.length} áƒáƒ—áƒáƒ®áƒ˜</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:80px;">áƒœáƒáƒ›áƒ”áƒ áƒ˜</th>
                            <th style="width:100px;">áƒ¢áƒ˜áƒáƒ˜</th>
                            <th style="width:100px;">áƒ¤áƒáƒ¡áƒ˜/áƒ¦áƒáƒ›áƒ”</th>
                            <th style="width:90px;">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</th>
                            <th>áƒ›áƒáƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ</th>
                        </tr>
                    </thead>
                    <tbody>`;

            floorRooms.forEach(r => {
                const isActive = r.is_active == 1;
                html += `
                    <tr style="${!isActive ? 'opacity:0.5; background:#fafafa;' : ''}">
                        <td><strong style="font-size:16px;">${esc(r.room_number)}</strong></td>
                        <td><span class="type-badge type-${r.room_type}">${r.room_type}</span></td>
                        <td>${parseFloat(r.default_price).toFixed(0)}áƒš</td>
                        <td><span class="${isActive ? 'status-active' : 'status-inactive'}">${isActive ? 'âœ… áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜' : 'âŒ áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜'}</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="openEditModal(${r.id})">âœï¸ áƒ¨áƒ”áƒªáƒ•áƒšáƒ</button>
                            ${isActive ?
                                `<button class="btn btn-sm" style="background:#6c757d;color:white;" onclick="toggleRoom(${r.id}, 0)">â¸ áƒ’áƒáƒ—áƒ˜áƒ¨áƒ•áƒ</button>` :
                                `<button class="btn btn-success btn-sm" onclick="toggleRoom(${r.id}, 1)">â–¶ áƒ©áƒáƒ áƒ—áƒ•áƒ</button>`
                            }
                            <button class="btn btn-danger btn-sm" onclick="deleteRoom(${r.id}, '${esc(r.room_number)}')">ğŸ—‘ï¸ áƒ¬áƒáƒ¨áƒšáƒ</button>
                        </td>
                    </tr>`;
            });

            html += `</tbody></table></div>`;
        });

        container.innerHTML = html;
    }

    // === Modal ===
    function openAddModal() {
        document.getElementById('modalTitle').textContent = 'â• áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ';
        document.getElementById('editId').value = '';
        document.getElementById('mRoomNumber').value = '';
        document.getElementById('mFloor').value = '';
        document.getElementById('mRoomType').value = 'Double';
        document.getElementById('mPrice').value = '';
        document.getElementById('statusRow').style.display = 'none';
        document.getElementById('roomModal').classList.add('show');
        document.getElementById('mRoomNumber').focus();
    }

    function openEditModal(id) {
        const r = rooms.find(rm => rm.id == id);
        if (!r) return;

        document.getElementById('modalTitle').textContent = 'âœï¸ áƒáƒ—áƒáƒ®áƒ˜ ' + r.room_number;
        document.getElementById('editId').value = r.id;
        document.getElementById('mRoomNumber').value = r.room_number;
        document.getElementById('mFloor').value = r.floor;
        document.getElementById('mRoomType').value = r.room_type;
        document.getElementById('mPrice').value = r.default_price;
        document.getElementById('mActive').value = r.is_active;
        document.getElementById('statusRow').style.display = 'block';
        document.getElementById('roomModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('roomModal').classList.remove('show');
    }

    async function saveRoom() {
        const id = document.getElementById('editId').value;
        const roomNumber = document.getElementById('mRoomNumber').value.trim();
        const floor = document.getElementById('mFloor').value;
        const roomType = document.getElementById('mRoomType').value;
        const price = document.getElementById('mPrice').value;

        if (!roomNumber || !floor) {
            alert('áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”áƒ— áƒœáƒáƒ›áƒ”áƒ áƒ˜ áƒ“áƒ áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜');
            return;
        }

        const payload = {
            room_number: roomNumber,
            room_type: roomType,
            floor: parseInt(floor),
            default_price: parseFloat(price) || 0
        };

        if (id) {
            payload.is_active = parseInt(document.getElementById('mActive').value);
        }

        try {
            const url = id
                ? API + '?action=room_update&id=' + id + '&_method=PUT'
                : API + '?action=room_add';

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            const json = await res.json();

            if (json.success) {
                closeModal();
                await loadRooms();
            } else {
                alert('âŒ ' + (json.error || 'áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ'));
            }
        } catch(e) {
            alert('âŒ áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ');
        }
    }

    async function toggleRoom(id, active) {
        const action = active ? 'áƒ©áƒáƒ áƒ—áƒ•áƒ' : 'áƒ’áƒáƒ—áƒ˜áƒ¨áƒ•áƒ';
        if (!confirm(`áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ¡áƒ£áƒ áƒ— áƒáƒ—áƒáƒ®áƒ˜áƒ¡ ${action}?`)) return;

        try {
            const res = await fetch(API + '?action=room_update&id=' + id + '&_method=PUT', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ is_active: active })
            });
            const json = await res.json();
            if (json.success) await loadRooms();
            else alert('âŒ ' + (json.error || ''));
        } catch(e) { alert('âŒ áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ'); }
    }

    async function deleteRoom(id, number) {
        if (!confirm(`áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ¡áƒ£áƒ áƒ— áƒáƒ—áƒáƒ®áƒ˜ ${number}-áƒ˜áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ?`)) return;

        try {
            const res = await fetch(API + '?action=room_delete&id=' + id + '&_method=DELETE', {
                method: 'POST',
                credentials: 'include'
            });
            const json = await res.json();
            if (json.success) {
                await loadRooms();
            } else {
                alert('âŒ ' + (json.error || ''));
            }
        } catch(e) { alert('âŒ áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ'); }
    }

    function esc(s) {
        if (!s) return '';
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeModal();
    });
</script>


</body>
</html>